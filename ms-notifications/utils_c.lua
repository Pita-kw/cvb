-- funkcja ruska to jest kurwa xD
-- (!) ???????? ??????? fDxGetTextHeight ??????? ????? ????

-- ?????? ??????? ???? ? ??????.
-- ???????? ????????? ???????? ???? ? dxDrawText
--
-- ???????? ????????? ??????? ?? ??????? \n, ???????? ????????? ??????
-- ??????????????? ?????????? ??? ??????. ???? ? ?????? ????? ??? \n
-- ??? ???????, ?? \n ????? ?????? ????????.
--
-- ?????????? ????? ?????, ??? ????????? ??????? ???????? ?? ??????? \n
function fWordWrap ( sText, nWidth, nFontScaleX, nFontScaleY, font, bReturnLinesCountToo )

    local sOutText, sCurLine, sCurWord, sSpaceBeforeWord, sSpaceAndWordGroup, sSpaceAndWordGroupEnd = "", "", "", "", "", 1
    local sSpaceAndWordGroupPattern = "(([\r\n\t -/:-?%[-`{-~]*)([^\r\n\t -/:-?%[-`{-~]+))"


    -- ??????? ????
    _, sSpaceAndWordGroupEnd, sSpaceAndWordGroup, sSpaceBeforeWord, sCurWord = sText:find (
        sSpaceAndWordGroupPattern,
        1
    )

    while sSpaceAndWordGroupEnd do

        if dxGetTextWidth( sCurLine .. sSpaceAndWordGroup, nFontScaleX, font ) > nWidth then

            -- ???? ???? ?????? ????
            if dxGetTextWidth( sSpaceAndWordGroup, nFontScaleX, font ) > nWidth then

                while true do
                    local sPartEnd = sSpaceAndWordGroup:len() - 1
                    local sPart =    sSpaceAndWordGroup:sub( 1, sPartEnd )

                    -- ????????? ????? ?? 1 ??????? ???? ??? ?? ?????? ?????? ? ??????? ?????????? ?????? ? ?????? ??????
                    -- ?????? 1 ??????? ????? ?? ????? ????
                    while sPartEnd >= 1 and dxGetTextWidth( sCurLine .. sSpaceAndWordGroup, nFontScaleX, font ) > nWidth do
                        sPartEnd =   sPartEnd - 1
                        sPart =      sSpaceAndWordGroup:sub( 1, sPartEnd )
                    end

                    -- ????? ?????? = ?????????? ????? ?? ????????? ?????
                    sCurLine = sSpaceAndWordGroup:sub( sPartEnd + 2, -1 )
                    -- ?????? = ?????? ????? ????? + \n
                    sSpaceAndWordGroup = sPart .. "\n" .. sCurLine

                    -- ???? ?????? ????? ????????? ???? ????? ????? ??????, ???? ????? ???????????
                    -- ??? ????? ??? ???????? ????? ?????? ????? ??????
                    if sPart:len() <= 1 or dxGetTextWidth( sCurLine .. sSpaceAndWordGroup, nFontScaleX, font ) <= nWidth then
                        break
                    end
                end

            else

                sSpaceAndWordGroup = sSpaceBeforeWord .. "\n" .. sCurWord
                sCurLine = sCurWord

            end


        else
            sCurLine = sCurLine .. sSpaceAndWordGroup
        end

        sOutText = sOutText .. sSpaceAndWordGroup

        _, sSpaceAndWordGroupEnd, sSpaceAndWordGroup, sSpaceBeforeWord, sCurWord = sText:find (
            sSpaceAndWordGroupPattern,
            sSpaceAndWordGroupEnd + 1
        )

    end
    --



    -- ??????? ? ?????? ???????, ??????? ???????? ???? ????????? ? ????? ??????
    sOutText = sOutText .. ( sText:match("[\r\n\t -/:-?%[-`{-~]*$") or "" )



    if bReturnLinesCountToo then
        -- ?????????? ???-?? ????? ? ?????????? ??????
        local nLines
        _, nLines = sOutText:gsub( "(\r?\n)", "%1" )

        -- ?????? ????? ????? ? ?????????? ? ???-?? ????? ? ????? ??????
        return sOutText, (nLines + 1)
    else
        return sOutText
    end

end




-- ???????????? ?????? ?????? ? ?????? ???????? ???? ? ????????????
-- ?????? ?????????? ??? ????? ? ????????
function dxGetTextHeight ( sText, font, nFontScaleX, nFontScaleY, nMaxWidth )

    if  type(sText) ~= 'string' or sText == '' or
        type(nMaxWidth) ~= 'number' or nMaxWidth <= 0 or
        type(nFontScaleX) ~= 'number' or nFontScaleX <= 0 or
        type(nFontScaleY) ~= 'number' or nFontScaleY <= 0 or
        ( type(font) ~= 'string' and type(font) ~= 'userdata' ) 
    then
        return 0
    end

    local _, nStrings = fWordWrap( sText, nMaxWidth, nFontScaleX, nFontScaleY, font, true )

    return dxGetFontHeight(nFontScaleY, font) * nStrings
end